# Sample workflow for building and deploying an Astro site to GitHub Pages
#
# To get started with Astro see: https://docs.astro.build/en/getting-started/
#
name: Deploy Astro site to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "zoe-site"
  cancel-in-progress: true

env:
  BUILD_PATH: "./" # default value when not using subfolders
  # BUILD_PATH: subfolder

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Detect package manager
        id: detect-package-manager
        run: |
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
            echo "runner=yarn" >> $GITHUB_OUTPUT
            echo "lockfile=yarn.lock" >> $GITHUB_OUTPUT
            exit 0
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: ${{ env.BUILD_PATH }}/yarn.lock
      - name: Install dependencies
        run: yarn install
        working-directory: ${{ env.BUILD_PATH }}
      - name: Build with Astro
        run: |
          yarn astro build
        working-directory: ${{ env.BUILD_PATH }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    name: Deploy to Hetzner via SFTP
    steps:
      - name: SFTP Deploy
      # You may pin to the exact commit or the version.
      # uses: wlixcc/SFTP-Deploy-Action@da88a4dbe95286266bbac3c0b2b8284048d20c8f
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
        # username
          username: jdewad_0
        # your sftp server
          server: www541.your-server.de
        # your sftp server port, default to 22
          port: 22 # default is 22
        # you can copy private_key from your *.pem file, keep format
        #  ssh_private_key: 
        # will put all file under this path
          local_path: ./deploy/* # default is ./deploy/*
        # files will copy to under remote_path
          remote_path: /
        # connection via sftp protocol only
          sftp_only: true # optional
        # sftp args
        #  sftpArgs: # optional
        # This operation will delete all files in the remote path before upload. Please be careful set this to true
          delete_remote_files: true # optional
        # SSH passswordï¼ŒIf a password is set, the secret key pair is ignored
          password: ${{ secrets.hetzner_sftp_pass }} # optional
          
